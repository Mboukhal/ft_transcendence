generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ONLINE
  OFFLINE
}

model User {
  id                      String            @id @default(uuid())
  intraId                 Int               @unique
  createdAt               DateTime          @default(now())

  profile                 UserProfile?
  preferences             UserPreferences?
  sensitiveData           UserSensitiveData?

  friends                 Friendship[]      @relation(name: "UserToFriendship")
  friendsOf               Friendship[]      @relation(name: "FriendshipToUser")

  bannedUsers             Ban[]             @relation(name: "BanToUser")
  bannedBy                Ban[]             @relation(name: "BanToBannedUser")

  messagesSent            MessageDm[]       @relation(name: "DMToSender")
  messagesRecived         MessageDm[]       @relation(name: "DMToReciver")

  gamesRecord             GameRecord[]      @relation(name: "UserToGamesRecord")
  oGamesRecord            GameRecord[]      @relation(name: "GamesRecordToUser")
}

model Ban {
  createdAt    DateTime    @default(now())

  user         User        @relation(name: "BanToUser", fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId       String

  bannedUser   User        @relation(name: "BanToBannedUser" ,fields: [bannedUserId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  bannedUserId String

  @@id([userId, bannedUserId], name: "BanUniqueConstraint")
}

model MessageDm {
  id          String      @id @default(uuid())
  createdAt   DateTime    @default(now())

  sender      User        @relation(name: "DMToSender", fields: [senderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  senderId    String

  receiver    User        @relation(name: "DMToReciver", fields: [receiverId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  receiverId  String

  content     String
}

model UserProfile {
  updatedAt DateTime                        @default(now())

  name      String                          @unique
  status    UserStatus                      @default(OFFLINE)

  user      User                            @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId    String                          @id

  freindRequestsSent      FriendRequest[]   @relation(name: "UserProfileToFriendRequest")
  friendRequestsReceived  FriendRequest[]   @relation(name: "FriendRequestToUserProfile")
}

model GameRecord {
  id            String      @id @default(uuid())
  createdAt     DateTime    @default(now())

  user          User @relation(name: "UserToGamesRecord", fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId        String

  opponent      User @relation(name: "GamesRecordToUser", fields: [opponentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  opponentId    String

  userScore     Int
  opponentScore Int
}

model UserPreferences {
  updatedAt                         DateTime  @default(now())

  isTwoFactorAuthenticationEnabled  Boolean   @default(false)

  user                              User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId                            String    @id
}

model UserSensitiveData {
  updatedAt                     DateTime  @default(now())

  twoFactorAuthenticationSecret String?
  iv                            String?

  user                          User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId                        String    @id
}

model Friendship {
  createdAt DateTime                        @default(now())

  user      User                            @relation(name: "UserToFriendship", fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId    String

  friend    User                            @relation(name: "FriendshipToUser", fields: [friendId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  friendId  String

  @@id([userId, friendId], name: "FriendshipUniqueConstraint")
}

model FriendRequest {
  createdAt           DateTime          @default(now())

  senderProfile       UserProfile       @relation("UserProfileToFriendRequest", fields: [senderId], references: [userId])
  senderId            String

  receiverProfile     UserProfile       @relation("FriendRequestToUserProfile", fields: [receiverId], references: [userId])
  receiverId          String

  @@id([senderId, receiverId], name: "FriendRequestUniqueConstraint")
}